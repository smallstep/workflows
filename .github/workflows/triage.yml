name: Triage

on:
  workflow_call:
    secrets:
      TRIAGE_PAT:
        required: false
    inputs:
      run-label-pr:
        required: false
        type: boolean
        default: true
      run-add-to-oss-triage-project:
        required: false
        type: boolean
        default: true

jobs:
  label-pr:
    name: Label PR
    if: (inputs.run-label-pr) && (github.event_name == 'pull_request_target')
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    runs-on: ubuntu-latest
    steps:
    - name: Install GH CLI
      run: |
        mkdir ../bin
        curl -L https://github.com/cli/cli/releases/download/v2.8.0/gh_2.8.0_linux_amd64.tar.gz \
          | tar xzvf - --strip-components=2 -C ../bin/ "gh_2.8.0_linux_amd64/bin/gh"

    - name: Checkout
      uses: actions/checkout@v3

    - name: Label PR
      run: |
        ../bin/gh pr edit ${{ .github.event.number }} --add-label "needs triage"

  add-oss-project:
    name: Add to OSS Triage Project
    if: (inputs.run-add-to-oss-triage-project)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/add-to-project@v0.3.0
        with:
          project-url: https://github.com/orgs/smallstep/projects/94
          github-token: ${{ secrets.TRIAGE_PAT }}
